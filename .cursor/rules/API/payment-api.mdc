---
description: 
globs: 
alwaysApply: false
---
# Create Payment API

## Endpoint

```
POST /server/payment/create
```

## Description

Creates a new payment record in the system. When only an order ID is provided, the API will automatically extract payment details from the order's payment_set or payment_method information.

## Request

### Headers

```
Content-Type: application/json
```

### Body Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| type | String | No* | Payment type (GATEWAY, COD, BANK_TRANSFER, MANUAL) |
| amount | String | No* | Payment amount |
| currency | String | No* | Currency ID |
| name | String | No | Payment name (generated by trigger if not provided) |
| status | String | No | Payment status (PAID, UNPAID, REFUNDED), defaults to UNPAID |
| paid_at | String | No | Timestamp when payment was paid |
| refunded_at | String | No | Timestamp when payment was refunded |
| customer | String | No* | Customer ID |
| order | String | Yes** | Order ID |
| external_name | String | No | External reference name/ID |
| provider_name | String | No | Payment provider name |
| provider_status_title | String | No | Payment provider status title |
| provider_status_code | Number | No | Payment provider status code |

*Required unless order ID is provided with associated payment details
**When only order ID is provided, payment details will be extracted from the order

## Example Requests

### Complete Payment Data

```json
{
  "type": "GATEWAY",
  "amount": "99.99",
  "currency": "USD",
  "customer": "123e4567-e89b-12d3-a456-426614174000",
  "order": "123e4567-e89b-12d3-a456-426614174001",
  "external_name": "PAYMENT_REF_123"
}
```

### Order-only Payment Creation

```json
{
  "order": "123e4567-e89b-12d3-a456-426614174001"
}
```

## Response

### Success (201 Created)

```json
{
  "success": true,
  "data": {
    "id": "123e4567-e89b-12d3-a456-426614174002",
    "name": "PMT-001", 
    "type": "GATEWAY",
    "amount": "99.99",
    "currency": "USD",
    "status": "UNPAID",
    "paid_at": null,
    "refunded_at": null,
    "customer": "123e4567-e89b-12d3-a456-426614174000",
    "order": "123e4567-e89b-12d3-a456-426614174001",
    "external_name": "PAYMENT_REF_123",
    "provider_name": null,
    "provider_status_title": null,
    "provider_status_code": null
  }
}
```

### Error (500 Internal Server Error)

```json
{
  "success": false,
  "error": "Error message details"
}
```

### Error (400 Bad Request)

```json
{
  "success": false,
  "error": "Payment type is required"
}
```

### Error (404 Not Found)

```json
{
  "success": false,
  "error": "Order with ID 123e4567-e89b-12d3-a456-426614174001 not found"
}
``` 

# Update Payment API

## Endpoints

There are three specialized update endpoints for payments:

1. Mark payment as paid
2. Refund payment
3. Update provider status

## Mark Payment as Paid

### Endpoint

```
PUT /server/payment/update/mark-paid/:id
```

### Description

Marks a payment as paid and sets the paid_at timestamp.

### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| id | UUID | Yes | ID of the payment to mark as paid |

### Headers

```
Content-Type: application/json
```

### Body Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| paid_at | String | No | Custom timestamp for when the payment was paid (defaults to current time) |
| provider_name | String | No | Payment provider name |
| provider_status_title | String | No | Payment provider status title |
| provider_status_code | Number | No | Payment provider status code |

### Example Request

```json
{
  "paid_at": "2023-06-15T14:30:00.000Z",
  "provider_name": "Stripe",
  "provider_status_title": "succeeded",
  "provider_status_code": 200
}
```

Or with no body to use the current timestamp:

```
PUT /server/payment/update/mark-paid/123e4567-e89b-12d3-a456-426614174000
```

### Response

#### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "name": "PMT-001",
    "type": "GATEWAY",
    "amount": "99.99",
    "currency": "USD",
    "status": "PAID",
    "paid_at": "2023-06-15T14:30:00.000Z",
    "refunded_at": null,
    "customer": "123e4567-e89b-12d3-a456-426614174001",
    "order": "123e4567-e89b-12d3-a456-426614174002",
    "external_name": "PAYMENT_REF_123",
    "provider_name": "Stripe",
    "provider_status_title": "succeeded",
    "provider_status_code": 200
  }
}
```

#### Error (404 Not Found)

```json
{
  "success": false,
  "error": "Payment not found"
}
```

#### Error (500 Internal Server Error)

```json
{
  "success": false,
  "error": "Error message details"
}
```

## Refund Payment

### Endpoint

```
PUT /server/payment/update/refund/:id
```

### Description

Refunds a paid payment and sets the refunded_at timestamp.

### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| id | UUID | Yes | ID of the payment to refund |

### Headers

```
Content-Type: application/json
```

### Body Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| refunded_at | String | No | Custom timestamp for when the payment was refunded (defaults to current time) |
| provider_name | String | No | Payment provider name |
| provider_status_title | String | No | Payment provider status title |
| provider_status_code | Number | No | Payment provider status code |

### Example Request

```json
{
  "refunded_at": "2023-06-16T10:15:00.000Z",
  "provider_status_title": "refunded",
  "provider_status_code": 200
}
```

Or with no body to use the current timestamp:

```
PUT /server/payment/update/refund/123e4567-e89b-12d3-a456-426614174000
```

### Response

#### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "name": "PMT-001",
    "type": "GATEWAY",
    "amount": "99.99",
    "currency": "USD",
    "status": "REFUNDED",
    "paid_at": "2023-06-15T14:30:00.000Z",
    "refunded_at": "2023-06-16T10:15:00.000Z",
    "customer": "123e4567-e89b-12d3-a456-426614174001",
    "order": "123e4567-e89b-12d3-a456-426614174002",
    "external_name": "PAYMENT_REF_123",
    "provider_name": "Stripe",
    "provider_status_title": "refunded",
    "provider_status_code": 200
  }
}
```

#### Error (400 Bad Request)

```json
{
  "success": false,
  "error": "Only paid payments can be refunded"
}
```

#### Error (404 Not Found)

```json
{
  "success": false,
  "error": "Payment not found"
}
```

#### Error (500 Internal Server Error)

```json
{
  "success": false,
  "error": "Error message details"
}
```

## Update Provider Status

### Endpoint

```
PUT /server/payment/update/provider-status/:id
```

### Description

Updates the provider-related status information for a payment without changing the payment status itself.

### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| id | UUID | Yes | ID of the payment to update provider status for |

### Headers

```
Content-Type: application/json
```

### Body Parameters

At least one of the following parameters must be provided:

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| provider_name | String | No* | Payment provider name |
| provider_status_title | String | No* | Payment provider status title |
| provider_status_code | Number | No* | Payment provider status code |

*At least one of these fields must be provided

### Example Request

```json
{
  "provider_name": "Stripe",
  "provider_status_title": "processing",
  "provider_status_code": 202
}
```

### Response

#### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "name": "PMT-001",
    "type": "GATEWAY",
    "amount": "99.99",
    "currency": "USD",
    "status": "UNPAID",
    "paid_at": null,
    "refunded_at": null,
    "customer": "123e4567-e89b-12d3-a456-426614174001",
    "order": "123e4567-e89b-12d3-a456-426614174002",
    "external_name": "PAYMENT_REF_123",
    "provider_name": "Stripe",
    "provider_status_title": "processing",
    "provider_status_code": 202
  }
}
```

#### Error (400 Bad Request)

```json
{
  "success": false,
  "error": "At least one provider status field must be provided"
}
```

#### Error (404 Not Found)

```json
{
  "success": false,
  "error": "Payment not found"
}
```

#### Error (500 Internal Server Error)

```json
{
  "success": false,
  "error": "Error message details"
}
``` 


# Modify Payment API

## Endpoint

```
PUT /server/payment/modify/:id
```

## Description

Updates an existing payment record with new values.

## Request

### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| id | UUID | Yes | ID of the payment to update |

### Headers

```
Content-Type: application/json
```

### Body Parameters

All parameters are optional. Only the parameters that are included will be updated.

| Parameter | Type | Description |
|-----------|------|-------------|
| name | String | Payment name |
| type | String | Payment type (GATEWAY, COD, BANK_TRANSFER, OTHER) |
| amount | String | Payment amount |
| currency | String | Currency ID |
| status | String | Payment status (PAID, UNPAID, REFUNDED) |
| paid_at | String | Timestamp when payment was paid |
| refunded_at | String | Timestamp when payment was refunded |
| customer | String | Customer ID |
| order | String | Order ID |
| external_name | String | External reference name/ID |

## Example Request

```json
{
  "amount": "149.99",
  "status": "PAID"
}
```

## Response

### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "name": "PMT-001",
    "type": "GATEWAY",
    "amount": "149.99",
    "currency": "USD",
    "status": "PAID",
    "paid_at": "2023-06-15T14:30:00.000Z",
    "refunded_at": null,
    "customer": "123e4567-e89b-12d3-a456-426614174001",
    "order": "123e4567-e89b-12d3-a456-426614174002",
    "external_name": "PAYMENT_REF_123"
  }
}
```

### Error (400 Bad Request)

```json
{
  "success": false,
  "error": "At least one field must be provided to update"
}
```

### Error (400 Bad Request)

```json
{
  "success": false,
  "error": "Invalid payment type. Must be one of: GATEWAY, COD, BANK_TRANSFER, OTHER"
}
```

### Error (404 Not Found)

```json
{
  "success": false,
  "error": "Payment not found"
}
```

### Error (500 Internal Server Error)

```json
{
  "success": false,
  "error": "Error message details"
}
``` 

# Delete Payment API

## Endpoint

```
DELETE /server/payment/delete/:id
```

## Description

Deletes a payment record by its ID.

## Request

### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| id | UUID | Yes | ID of the payment to delete |

## Example Request

```
DELETE /server/payment/delete/123e4567-e89b-12d3-a456-426614174000
```

## Response

### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "name": "PMT-001",
    "type": "GATEWAY",
    "amount": "99.99",
    "currency": "USD",
    "status": "UNPAID",
    "paid_at": null,
    "refunded_at": null,
    "customer": "123e4567-e89b-12d3-a456-426614174001",
    "order": "123e4567-e89b-12d3-a456-426614174002",
    "external_name": "PAYMENT_REF_123"
  }
}
```

### Error (404 Not Found)

```json
{
  "success": false,
  "error": "Payment not found"
}
```

### Error (500 Internal Server Error)

```json
{
  "success": false,
  "error": "Error message details"
}
``` 