### Query Endpoint

**POST** `/server/bank/query`

Query bank transactions with advanced filtering, pagination, and expansion.

#### Request Body Schema

```json
{
  "filters": {
    "bank_account": "string (UUID)",
    "payment": "string (UUID)",
    "type": "INCOMING | OUTGOING",
    "category": "PAYMENT | REFUND | FEE | TRANSFER | OTHER",
    "reconciled": "boolean",
    "date_from": "string (YYYY-MM-DD)",
    "date_to": "string (YYYY-MM-DD)",
    "amount_gt": "number",
    "amount_lt": "number",
    "amount_eq": "number",
    "variable_symbol": "string",
    "reference_number": "string",
    "counterparty": "string (partial match, case-insensitive)"
  },
  "expand": ["payment", "bank_account"],
  "page": "number (default: 1)",
  "limit": "number (default: 50, max: 100)",
  "orderBy": "string (default: 'transaction_date')",
  "ascending": "boolean (default: false)"
}
```

#### Available Filter Fields

| Field | Type | Description |
|-------|------|-------------|
| `bank_account` | UUID | Filter by bank account |
| `payment` | UUID | Filter by linked payment |
| `type` | Enum | INCOMING or OUTGOING |
| `category` | Enum | PAYMENT, REFUND, FEE, TRANSFER, OTHER |
| `reconciled` | Boolean | true = reconciled, false = unreconciled |
| `date_from` | Date | Start date (YYYY-MM-DD) |
| `date_to` | Date | End date (YYYY-MM-DD) |
| `amount_gt` | Number | Amount greater than |
| `amount_lt` | Number | Amount less than |
| `amount_eq` | Number | Amount equal to |
| `variable_symbol` | String | Exact match on variable symbol |
| `reference_number` | String | Exact match on bank reference |
| `counterparty` | String | Partial match on counterparty name |

#### Expansion Options

| Value | Expands |
|-------|---------|
| `payment` | Includes payment details (id, name, amount, status, order) |
| `bank_account` | Includes bank account details (id, name, account_number, iban, currency) |

#### Response Schema

```json
{
  "success": true,
  "data": {
    "records": [
      {
        "id": "string (UUID)",
        "bank_account": "string (UUID) | null",
        "transaction_date": "string (YYYY-MM-DD)",
        "amount": "number",
        "currency": "string",
        "type": "INCOMING | OUTGOING",
        "category": "PAYMENT | REFUND | FEE | TRANSFER | OTHER | null",
        "payment": "string (UUID) | null",
        "reconciled": "boolean",
        "reconciled_at": "string (ISO timestamp) | null",
        "reconciliation_amount": "number | null",
        "reference_number": "string | null",
        "counterparty_name": "string | null",
        "counterparty_account": "string | null",
        "variable_symbol": "string | null",
        "constant_symbol": "string | null",
        "specific_symbol": "string | null",
        "description": "string | null",
        "note": "string | null",
        "metadata": "object",
        "created_at": "string (ISO timestamp)",
        "updated_at": "string (ISO timestamp)",
        "reconciliation_status": "EXACT_MATCH | OVERPAID | UNDERPAID | UNRECONCILED",
        "reconciliation_difference": "number | null"
      }
    ],
    "pagination": {
      "page": "number",
      "limit": "number",
      "totalRecords": "number",
      "totalPages": "number"
    }
  }
}
```

#### Calculated Fields (Always Included)

| Field | Type | Description |
|-------|------|-------------|
| `reconciliation_status` | Enum | EXACT_MATCH, OVERPAID, UNDERPAID, or UNRECONCILED |
| `reconciliation_difference` | Number\|null | Absolute difference between transaction and payment amounts |

#### Reconciliation Status Values

| Status | Meaning |
|--------|---------|
| `EXACT_MATCH` | Transaction amount = Payment amount |
| `OVERPAID` | Transaction amount > Payment amount (customer paid more) |
| `UNDERPAID` | Transaction amount < Payment amount (customer paid less) |
| `UNRECONCILED` | Not reconciled to any payment |

---

### Retrieve Endpoint

**GET** `/server/bank/retrieve/:id`

Retrieve a single transaction by ID.

#### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | UUID | Yes | Transaction UUID |

#### Query Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `expand` | String | Comma-separated: `payment`, `bank_account` |

#### Response Schema

```json
{
  "success": true,
  "data": {
    "id": "string (UUID)",
    "bank_account": "string (UUID) | null",
    "transaction_date": "string (YYYY-MM-DD)",
    "amount": "number",
    "currency": "string",
    "type": "INCOMING | OUTGOING",
    "category": "string | null",
    "payment": "string (UUID) | null",
    "reconciled": "boolean",
    "reconciled_at": "string | null",
    "reconciliation_amount": "number | null",
    "reference_number": "string | null",
    "counterparty_name": "string | null",
    "counterparty_account": "string | null",
    "variable_symbol": "string | null",
    "constant_symbol": "string | null",
    "specific_symbol": "string | null",
    "description": "string | null",
    "note": "string | null",
    "metadata": "object",
    "created_at": "string",
    "updated_at": "string",
    "reconciliation_status": "string",
    "reconciliation_difference": "number | null"
  }
}
```

---

### Retrieve by Payment

**GET** `/server/bank/retrieve/payment/:paymentId`

Retrieve all transactions linked to a specific payment.

#### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `paymentId` | UUID | Yes | Payment UUID |

#### Query Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `expand` | String | Comma-separated: `bank_account` |

#### Response Schema

```json
{
  "success": true,
  "data": [
    {
      "id": "string",
      "amount": "number",
      "type": "string",
      "payment": "string",
      "reconciled": "boolean",
      "reconciliation_status": "string",
      "reconciliation_difference": "number | null"
    }
  ],
  "count": "number"
}
```

---

### Reconcile Endpoint

**PUT** `/server/bank/reconcile/:id`

Link a transaction to a payment. Automatically detects amount mismatches.

#### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | UUID | Yes | Transaction UUID |

#### Request Body

```json
{
  "payment_id": "string (UUID, required)"
}
```

#### Response Schema

```json
{
  "success": true,
  "data": {
    "id": "string",
    "payment": "string",
    "reconciled": true,
    "reconciled_at": "string",
    "reconciliation_amount": "number",
    "reconciliation_status": "EXACT_MATCH | OVERPAID | UNDERPAID",
    "reconciliation_difference": "number | null",
    "warning": "string | undefined"
  }
}
```

**Note:** `warning` field is only present when `reconciliation_status` is not `EXACT_MATCH`.

---

### Unreconcile Endpoint

**PUT** `/server/bank/unreconcile/:id`

Remove payment link from a transaction.

#### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | UUID | Yes | Transaction UUID |

#### Response Schema

```json
{
  "success": true,
  "data": {
    "id": "string",
    "payment": null,
    "reconciled": false,
    "reconciled_at": null,
    "reconciliation_amount": null,
    "reconciliation_status": "UNRECONCILED",
    "reconciliation_difference": null
  }
}
```

---

### Balance Endpoint

**GET** `/server/bank/balance/:accountId`

Calculate account balance.

#### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `accountId` | UUID | Yes | Bank account UUID |

#### Query Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `as_of_date` | String | Calculate balance as of date (YYYY-MM-DD) |

#### Response Schema

```json
{
  "success": true,
  "data": {
    "account_id": "string",
    "balance": "string (formatted number)",
    "as_of_date": "string (ISO timestamp)",
    "transaction_count": "number"
  }
}
```

---

### Balance Breakdown Endpoint

**GET** `/server/bank/balance/:accountId/breakdown`

Get balance breakdown by category.

#### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `accountId` | UUID | Yes | Bank account UUID |

#### Query Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `date_from` | String | Start date (YYYY-MM-DD) |
| `date_to` | String | End date (YYYY-MM-DD) |

#### Response Schema

```json
{
  "success": true,
  "data": {
    "total_incoming": "number",
    "total_outgoing": "number",
    "net": "number",
    "by_category": {
      "PAYMENT": {
        "incoming": "number",
        "outgoing": "number"
      },
      "REFUND": {
        "incoming": "number",
        "outgoing": "number"
      },
      "FEE": {
        "incoming": "number",
        "outgoing": "number"
      }
    }
  }
}
```

---

### Error Response Schema

All endpoints return errors in this format:

```json
{
  "success": false,
  "error": "string (error message)"
}
```

#### Common HTTP Status Codes

| Code | Meaning |
|------|---------|
| 200 | Success (GET, PUT) |
| 201 | Created (POST) |
| 400 | Bad Request (validation error) |
| 404 | Not Found (invalid ID) |
| 500 | Server Error |

---

### Transaction States

| State | Description |
|-------|-------------|
| `reconciled: false` | Not yet matched to a payment |
| `reconciled: true` + `EXACT_MATCH` | Perfect match ✅ |
| `reconciled: true` + `OVERPAID` | Customer paid more ⚠️ |
| `reconciled: true` + `UNDERPAID` | Customer paid less ⚠️

### Common Frontend Queries

#### 1. Get All Unreconciled Transactions (Dashboard)

**Use Case:** Show pending transactions that need to be reconciled

```javascript
async function getUnreconciledTransactions(bankAccountId = null) {
  const payload = {
    filters: {
      reconciled: false,
      type: "INCOMING"
    },
    expand: ["bank_account"],
    orderBy: "transaction_date",
    ascending: false,
    page: 1,
    limit: 50
  };
  
  // Optionally filter by bank account
  if (bankAccountId) {
    payload.filters.bank_account = bankAccountId;
  }
  
  const response = await fetch('/server/bank/query', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  
  const result = await response.json();
  
  if (result.success) {
    return {
      transactions: result.data.records,
      pagination: result.data.pagination
    };
  }
  
  throw new Error(result.error);
}

// Usage in React/Vue/etc:
const { transactions, pagination } = await getUnreconciledTransactions();
```

#### 2. Get Transactions by Date Range (Reports)

**Use Case:** Monthly or custom period reports

```javascript
async function getTransactionsByDateRange(startDate, endDate, filters = {}) {
  const payload = {
    filters: {
      date_from: startDate,  // "2024-01-01"
      date_to: endDate,      // "2024-01-31"
      ...filters
    },
    expand: ["payment", "bank_account"],
    orderBy: "transaction_date",
    ascending: false,
    page: 1,
    limit: 100
  };
  
  const response = await fetch('/server/bank/query', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  
  const result = await response.json();
  return result.success ? result.data : null;
}

// Usage:
const data = await getTransactionsByDateRange('2024-01-01', '2024-01-31', {
  type: 'INCOMING',
  bank_account: 'account-uuid'
});
```

#### 3. Search by Variable Symbol (Quick Search)

**Use Case:** Find transaction by variable symbol from customer

```javascript
async function searchByVariableSymbol(variableSymbol) {
  const response = await fetch('/server/bank/query', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      filters: {
        variable_symbol: variableSymbol
      },
      expand: ["payment", "bank_account"]
    })
  });
  
  const result = await response.json();
  
  if (result.success && result.data.records.length > 0) {
    return result.data.records[0]; // Return first match
  }
  
  return null;
}

// Usage:
const transaction = await searchByVariableSymbol('1234567890');
if (transaction) {
  console.log('Found:', transaction);
}
```

#### 4. Get Single Transaction with Details

**Use Case:** Transaction detail page

```javascript
async function getTransactionDetails(transactionId) {
  const response = await fetch(
    `/server/bank/retrieve/${transactionId}?expand=payment,bank_account`,
    { method: 'GET' }
  );
  
  const result = await response.json();
  
  if (result.success) {
    const transaction = result.data;
    
    // Transaction includes calculated fields:
    // - reconciliation_status
    // - reconciliation_difference
    // - warning (if mismatch)
    
    return transaction;
  }
  
  throw new Error(result.error);
}

// Usage:
const transaction = await getTransactionDetails('transaction-uuid');
console.log('Status:', transaction.reconciliation_status);
console.log('Difference:', transaction.reconciliation_difference);
```

#### 5. Get All Mismatched Transactions (Review Page)

**Use Case:** Show transactions with amount mismatches for review

```javascript
async function getMismatchedTransactions() {
  const response = await fetch('/server/bank/query', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      filters: {
        reconciled: true
      },
      expand: ["payment"],
      limit: 100
    })
  });
  
  const result = await response.json();
  
  if (result.success) {
    // Filter for mismatches in frontend
    const mismatches = result.data.records.filter(t => 
      t.reconciliation_status === 'OVERPAID' || 
      t.reconciliation_status === 'UNDERPAID'
    );
    
    return mismatches;
  }
  
  return [];
}

// Usage:
const mismatches = await getMismatchedTransactions();
console.log(`Found ${mismatches.length} mismatched transactions`);
```

#### 6. Reconcile Transaction (Action)

**Use Case:** Match transaction to payment with mismatch detection

```javascript
async function reconcileTransaction(transactionId, paymentId) {
  const response = await fetch(`/server/bank/reconcile/${transactionId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      payment_id: paymentId
    })
  });
  
  const result = await response.json();
  
  if (result.success) {
    const transaction = result.data;
    
    // Check for mismatch warning
    if (transaction.warning) {
      console.warn('Reconciliation warning:', transaction.warning);
      // Show warning to user in UI
      return {
        success: true,
        transaction,
        warning: transaction.warning,
        status: transaction.reconciliation_status,
        difference: transaction.reconciliation_difference
      };
    }
    
    return {
      success: true,
      transaction,
      warning: null
    };
  }
  
  throw new Error(result.error);
}

// Usage with UI feedback:
try {
  const result = await reconcileTransaction('trans-uuid', 'payment-uuid');
  
  if (result.warning) {
    // Show warning modal/toast
    showWarning({
      title: 'Amount Mismatch Detected',
      message: result.warning,
      status: result.status,
      difference: result.difference
    });
  } else {
    // Show success message
    showSuccess('Transaction reconciled successfully');
  }
} catch (error) {
  showError(error.message);
}
```

#### 7. Get Account Balance (Dashboard Widget)

**Use Case:** Display current account balance

```javascript
async function getAccountBalance(accountId, asOfDate = null) {
  let url = `/server/bank/balance/${accountId}`;
  if (asOfDate) {
    url += `?as_of_date=${asOfDate}`;
  }
  
  const response = await fetch(url, { method: 'GET' });
  const result = await response.json();
  
  if (result.success) {
    return {
      balance: parseFloat(result.data.balance),
      transactionCount: result.data.transaction_count,
      asOfDate: result.data.as_of_date
    };
  }
  
  throw new Error(result.error);
}

// Usage:
const balance = await getAccountBalance('account-uuid');
console.log(`Balance: ${balance.balance} (${balance.transactionCount} transactions)`);
```

#### 8. Get Balance Breakdown (Analytics)

**Use Case:** Show income/expense breakdown by category

```javascript
async function getBalanceBreakdown(accountId, dateFrom, dateTo) {
  const params = new URLSearchParams({
    date_from: dateFrom,
    date_to: dateTo
  });
  
  const response = await fetch(
    `/server/bank/balance/${accountId}/breakdown?${params}`,
    { method: 'GET' }
  );
  
  const result = await response.json();
  
  if (result.success) {
    return {
      totalIncoming: result.data.total_incoming,
      totalOutgoing: result.data.total_outgoing,
      net: result.data.net,
      byCategory: result.data.by_category
    };
  }
  
  throw new Error(result.error);
}

// Usage:
const breakdown = await getBalanceBreakdown(
  'account-uuid',
  '2024-01-01',
  '2024-01-31'
);

console.log('Net:', breakdown.net);
console.log('Categories:', breakdown.byCategory);
```


```javascript
function ReconciliationWarning({ transaction }) {
  if (transaction.reconciliation_status === 'EXACT_MATCH') {
    return null;
  }
  
  const isOverpaid = transaction.reconciliation_status === 'OVERPAID';
  const isUnderpaid = transaction.reconciliation_status === 'UNDERPAID';
  
  return (
    <div className={`alert alert-${isOverpaid ? 'warning' : 'danger'}`}>
      <strong>Amount Mismatch Detected</strong>
      
      <p>
        Transaction amount: <strong>{transaction.amount} {transaction.currency}</strong><br/>
        Payment amount: <strong>{transaction.reconciliation_amount} {transaction.currency}</strong><br/>
        Difference: <strong>{transaction.reconciliation_difference} {transaction.currency}</strong>
      </p>
      
      {isOverpaid && (
        <p>Customer paid <strong>more</strong> than expected. Consider issuing a refund or credit.</p>
      )}
      
      {isUnderpaid && (
        <p>Customer paid <strong>less</strong> than expected. This may indicate fees or partial payment.</p>
      )}
      
      <button onClick={() => handleAddNote(transaction.id)}>
        Add Explanation
      </button>
    </div>
  );
}
```

### Response Data Structure

All query and retrieve endpoints return transactions with these fields:

```typescript
interface BankTransaction {
  // Database fields
  id: string;
  bank_account: string | null;
  transaction_date: string;  // "YYYY-MM-DD"
  amount: number;
  currency: string;
  type: "INCOMING" | "OUTGOING";
  category: "PAYMENT" | "REFUND" | "FEE" | "TRANSFER" | "OTHER" | null;
  payment: string | null;  // Payment UUID if reconciled
  reconciled: boolean;
  reconciled_at: string | null;  // ISO timestamp
  reconciliation_amount: number | null;  // Payment amount
  reference_number: string | null;
  counterparty_name: string | null;
  counterparty_account: string | null;
  variable_symbol: string | null;
  constant_symbol: string | null;
  specific_symbol: string | null;
  description: string | null;
  note: string | null;
  metadata: object;
  created_at: string;  // ISO timestamp
  updated_at: string;  // ISO timestamp
  
  // Calculated fields (always included in responses)
  reconciliation_status: "EXACT_MATCH" | "OVERPAID" | "UNDERPAID" | "UNRECONCILED";
  reconciliation_difference: number | null;  // Absolute difference
  
  // Optional warning (only on reconciliation with mismatch)
  warning?: string;
  
  // Expanded relations (if requested)
  payment?: {
    id: string;
    name: string;
    amount: number;
    status: string;
    order: string;
  };
  bank_account?: {
    id: string;
    name: string;
    account_number: string;
    iban: string;
    currency: string;
  };
}
```
