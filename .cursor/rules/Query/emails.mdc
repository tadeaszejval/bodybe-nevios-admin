---
description: 
globs: 
alwaysApply: false
---
# Emails Query API

## Overview
The Emails Query API provides flexible endpoints for retrieving and searching email records with comprehensive filtering, pagination, expansion, and search capabilities.

## Parameters Reference

### Core Parameters
| Parameter | Type | Location | Default | Description |
|-----|---|----|---|----|
| `page` | integer | URL/Body | 1 | Page number (1-based) |
| `limit` | integer | URL/Body | 50 | Records per page (max: 100) |
| `orderBy` | string | URL/Body | 'created_at' | Column to sort by |
| `ascending` | boolean | URL/Body | false | Sort order (true = ascending, false = descending) |
| `select` | string | URL/Body | '*' | Columns to select |
| `expand` | string/array | URL/Body | [] | Related records to expand |

### Expansion Options
| Expansion | Description | Returns |
|-----|----|---|
| `customer` | Expand customer details | Full customer object with email, name, phone, etc. |

### Filter Parameters (Body Only)
| Parameter | Type | Description | Example |
|-----|---|----|---|
| `filters.status` | string | Filter by email status | "SENT", "DELIVERED", "BOUNCED" |
| `filters.domain` | string | Filter by email domain | "seline.cz", "gmail.com" |
| `filters.sender_name` | string | Filter by sender name | "Nevios", "Support Team" |
| `filters.from` | string | Filter by sender email | "hello@seline.cz" |
| `filters.customer` | string | Filter by customer UUID | "95e6d65c-5eff-4b69-932a-e373d9f153c1" |
| `filters.order` | string | Filter by order UUID | "12345678-1234-1234-1234-123456789012" |

### Search Parameters
| Parameter | Type | Location | Required | Description |
|-----|---|----|---|----|
| `search` | string | Body | Yes (for search) | Search term to look for across multiple fields |

## Search Fields
The search functionality looks across the following fields:

### Email Table Fields
- `subject` - Email subject line
- `from` - Sender email address
- `to` - Recipient email address(es)
- `sender_name` - Display name of sender
- `domain` - Email domain (extracted from sender)
- `status` - Email delivery status
- `resend_id` - Resend service ID

### Related Fields (via expansion)
- `customer.email` - Customer email address
- `customer.phone` - Customer phone number
- `customer.full_name` - Customer full name
- `customer.first_name` - Customer first name
- `customer.last_name` - Customer last name

## Endpoints

### Query Emails
**POST** `/server/emails/query`

Retrieve emails with optional filtering, pagination, expansion, and search.

#### Request Parameters

**URL Parameters (Optional):**
- `page` (integer): Page number (default: 1)
- `limit` (integer): Records per page (default: 50, max: 100)
- `orderBy` (string): Column to sort by (default: 'created_at')
- `ascending` (boolean): Sort order (default: false)
- `expand` (string): Comma-separated expansion options

**Request Body (Optional):**
```json
{
  "page": 1,
  "limit": 50,
  "orderBy": "created_at",
  "ascending": false,
  "expand": ["customer"],
  "filters": {
    "status": "SENT",
    "domain": "seline.cz",
    "customer": "95e6d65c-5eff-4b69-932a-e373d9f153c1"
  },
  "search": "order confirmation"
}
```

#### Example Requests

**Basic Query:**
```bash
curl -X POST http://localhost:3000/server/emails/query \
  -H "Content-Type: application/json" \
  -d '{
    "page": 1,
    "limit": 10
  }'
```

**Query with Filters:**
```bash
curl -X POST http://localhost:3000/server/emails/query \
  -H "Content-Type: application/json" \
  -d '{
    "filters": {
      "status": "SENT",
      "domain": "seline.cz"
    },
    "orderBy": "created_at",
    "ascending": false
  }'
```

**Query with Customer Expansion:**
```bash
curl -X POST http://localhost:3000/server/emails/query \
  -H "Content-Type: application/json" \
  -d '{
    "expand": ["customer"],
    "limit": 5
  }'
```

**Search Emails:**
```bash
curl -X POST http://localhost:3000/server/emails/query \
  -H "Content-Type: application/json" \
  -d '{
    "search": "order confirmation",
    "expand": ["customer"]
  }'
```

**URL Parameters Example:**
```bash
curl -X POST "http://localhost:3000/server/emails/query?page=2&limit=25&expand=customer"
```

#### Response Format

**Success Response (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": "12345678-1234-1234-1234-123456789012",
      "created_at": "2024-01-15T10:30:00.000Z",
      "domain": "seline.cz",
      "from": "hello@seline.cz",
      "to": "customer@example.com",
      "html": "<html>...</html>",
      "headers": {
        "X-Custom-Header": "value"
      },
      "status": "SENT",
      "resend_id": "re_abc123def456",
      "sender_name": "Nevios",
      "scheduled_at": null,
      "customer": "95e6d65c-5eff-4b69-932a-e373d9f153c1",
      "order": "87654321-4321-4321-4321-210987654321",
      "subject": "Order Confirmation #12345"
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 5,
    "totalRecords": 247,
    "recordsPerPage": 50,
    "hasNextPage": true,
    "hasPreviousPage": false,
    "recordsOnCurrentPage": 50
  },
  "filters": {
    "status": "SENT"
  },
  "orderBy": {
    "column": "created_at",
    "ascending": false
  },
  "expansions": []
}
```

**With Customer Expansion:**
```json
{
  "success": true,
  "data": [
    {
      "id": "12345678-1234-1234-1234-123456789012",
      "created_at": "2024-01-15T10:30:00.000Z",
      "domain": "seline.cz",
      "from": "hello@seline.cz",
      "to": "customer@example.com",
      "subject": "Order Confirmation #12345",
      "status": "SENT",
      "customer": {
        "id": "95e6d65c-5eff-4b69-932a-e373d9f153c1",
        "email": "customer@example.com",
        "phone": "+420123456789",
        "first_name": "John",
        "last_name": "Doe",
        "full_name": "John Doe",
        "country": "CZ",
        "created_at": "2024-01-10T08:00:00.000Z"
      },
      "order": "87654321-4321-4321-4321-210987654321"
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 1,
    "totalRecords": 1,
    "recordsPerPage": 50,
    "hasNextPage": false,
    "hasPreviousPage": false,
    "recordsOnCurrentPage": 1
  },
  "expansions": ["customer"]
}
```

**Search Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "12345678-1234-1234-1234-123456789012",
      "subject": "Order Confirmation #12345",
      "from": "hello@seline.cz",
      "to": "customer@example.com",
      "status": "SENT",
      "customer": "95e6d65c-5eff-4b69-932a-e373d9f153c1"
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 1,
    "totalRecords": 3,
    "recordsPerPage": 50,
    "hasNextPage": false,
    "hasPreviousPage": false,
    "recordsOnCurrentPage": 3
  },
  "searchTerm": "order confirmation",
  "filters": {},
  "orderBy": {
    "column": "created_at",
    "ascending": false
  },
  "expansions": []
}
```

#### Error Responses

**400 Bad Request:**
```json
{
  "success": false,
  "error": "Page must be greater than 0"
}
```

**500 Internal Server Error:**
```json
{
  "success": false,
  "error": "Failed to query emails: Database connection failed"
}
```

## Usage Examples

### Filter by Email Status
```json
{
  "filters": {
    "status": "DELIVERED"
  }
}
```

### Filter by Date Range (using orderBy and pagination)
```json
{
  "orderBy": "created_at",
  "ascending": true,
  "filters": {
    "created_at": "2024-01-01%"
  }
}
```

### Search Customer Emails
```json
{
  "search": "john.doe@example.com",
  "expand": ["customer"]
}
```

### Get Recent Failed Emails
```json
{
  "filters": {
    "status": ["BOUNCED", "COMPLAINED"]
  },
  "orderBy": "created_at",
  "ascending": false,
  "limit": 20
}
```

## Notes

- **Parameter Precedence**: Request body parameters override URL parameters
- **Search Performance**: Search queries may take longer as they search across multiple fields and related tables
- **Expansion Impact**: Using expansions increases response size and query time
- **Rate Limiting**: Standard API rate limits apply
- **Pagination**: Maximum limit is 100 records per page 