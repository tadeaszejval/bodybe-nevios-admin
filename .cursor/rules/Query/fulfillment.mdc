---
description: 
globs: 
alwaysApply: false
---
# Fulfillment Query API

## Endpoint
**POST** `/server/fulfilment/query`

## Description
Query fulfillments with advanced filtering, pagination, sorting, expansion of related records, and optional text search across multiple fields. This endpoint supports both URL parameters and request body parameters, with body parameters taking precedence.

## Request Parameters

### URL Parameters (Optional)
All parameters can be passed as URL query parameters:
- `page` (integer): Page number (default: 1)
- `limit` (integer): Records per page (default: 50, max: 100)
- `orderBy` (string): Column to sort by (default: 'created_at')
- `ascending` (boolean): Sort order (default: false)
- `expand` (string): Comma-separated list of relations to expand
- Any other parameters will be treated as filters

### Request Body Parameters
```json
{
  "page": 1,
  "limit": 50,
  "orderBy": "created_at",
  "ascending": false,
  "expand": ["customer", "order", "shipping_address"],
  "search": "search term",
  "filters": {
    "status": "FULFILLED",
    "type": "standard",
    "carrier_name": "UPS"
  }
}
```

#### Body Parameters
- `page` (integer, optional): Page number (default: 1)
- `limit` (integer, optional): Records per page (default: 50, max: 100)
- `orderBy` (string, optional): Column to sort by (default: 'created_at')
- `ascending` (boolean, optional): Sort order (default: false)
- `expand` (array/string, optional): Relations to expand
- `search` (string, optional): Search term for multi-field search
- `filters` (object, optional): Filter criteria

#### Available Expansions
- `customer`: Expand customer information
- `order`: Expand order information
- `shipping_address`: Expand shipping address details
- `all`: Expand all available relations

#### Available Filters
- `id` (string): Fulfillment ID
- `type` (string): Fulfillment type
- `name` (string): Fulfillment name
- `status` (string): Fulfillment status (UNFULFILLED, FULFILLED, CANCELLED, etc.)
- `tracking` (string): Tracking number
- `order` (string): Order ID
- `carrier_name` (string): Carrier name
- `customer` (string): Customer ID
- `carrier_status` (string): Carrier status
- `delivery_status` (string): Delivery status
- `shipping_type` (string): Shipping type

#### Search Fields
When using the `search` parameter, the system searches across:
- Fulfillment fields: name, type, status, tracking, carrier_name, carrier_status, delivery_status, shipping_type, external_name
- Customer fields (when expanded): first_name, last_name, full_name, email, phone
- Order fields (when expanded): name, payment_status, fulfillment_status

## Example Requests

### Basic Query
```bash
curl -X POST http://localhost:3000/server/fulfilment/query \
  -H "Content-Type: application/json" \
  -d '{
    "page": 1,
    "limit": 20,
    "orderBy": "created_at",
    "ascending": false
  }'
```

### Query with Filters
```bash
curl -X POST http://localhost:3000/server/fulfilment/query \
  -H "Content-Type: application/json" \
  -d '{
    "filters": {
      "status": "FULFILLED",
      "carrier_name": "UPS"
    },
    "expand": ["customer", "order"]
  }'
```

### Search Query
```bash
curl -X POST http://localhost:3000/server/fulfilment/query \
  -H "Content-Type: application/json" \
  -d '{
    "search": "john@example.com",
    "expand": ["customer"],
    "limit": 10
  }'
```

### URL Parameters Example
```bash
curl -X POST "http://localhost:3000/server/fulfilment/query?page=2&limit=25&status=FULFILLED&expand=customer,order"
```

## Response Format

### Success Response (200 OK)
```json
{
  "success": true,
  "data": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "type": "standard",
      "name": "Fulfillment #1001",
      "status": "FULFILLED",
      "tracking": "1Z999AA1234567890",
      "tracking_link": "https://www.ups.com/track?tracknum=1Z999AA1234567890",
      "order": "456e7890-e89b-12d3-a456-426614174001",
      "carrier_name": "UPS",
      "shipping_address": "789e0123-e89b-12d3-a456-426614174002",
      "carrier_status": "delivered",
      "delivery_status": "DELIVERED",
      "shipping_type": "standard",
      "external_name": "UPS Ground",
      "customer": "321e6543-e89b-12d3-a456-426614174003",
      "created_at": "2024-01-15T10:30:00Z"
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 5,
    "totalRecords": 100,
    "recordsPerPage": 20,
    "hasNextPage": true,
    "hasPreviousPage": false,
    "recordsOnCurrentPage": 20
  },
  "filters": {
    "status": "FULFILLED"
  },
  "orderBy": {
    "column": "created_at",
    "ascending": false
  },
  "expansions": ["customer", "order"]
}
```

### Success Response with Expansions
```json
{
  "success": true,
  "data": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "name": "Fulfillment #1001",
      "status": "FULFILLED",
      "tracking": "1Z999AA1234567890",
      "customer": {
        "id": "321e6543-e89b-12d3-a456-426614174003",
        "first_name": "John",
        "last_name": "Doe",
        "email": "john.doe@example.com",
        "phone": "+1234567890"
      },
      "order": {
        "id": "456e7890-e89b-12d3-a456-426614174001",
        "name": "Order #2001",
        "payment_status": "PAID",
        "fulfillment_status": "FULFILLED"
      },
      "created_at": "2024-01-15T10:30:00Z"
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 1,
    "totalRecords": 1,
    "recordsPerPage": 50,
    "hasNextPage": false,
    "hasPreviousPage": false,
    "recordsOnCurrentPage": 1
  }
}
```

### Search Response
```json
{
  "success": true,
  "data": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "name": "Fulfillment #1001",
      "status": "FULFILLED",
      "customer": {
        "id": "321e6543-e89b-12d3-a456-426614174003",
        "email": "john@example.com",
        "first_name": "John",
        "last_name": "Doe"
      }
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 1,
    "totalRecords": 1,
    "recordsPerPage": 10,
    "hasNextPage": false,
    "hasPreviousPage": false,
    "recordsOnCurrentPage": 1
  },
  "searchTerm": "john@example.com",
  "filters": {},
  "orderBy": {
    "column": "created_at",
    "ascending": false
  },
  "expansions": ["customer"]
}
```

## Error Responses

### Bad Request (400)
```json
{
  "success": false,
  "error": "Page must be greater than 0"
}
```

### Server Error (500)
```json
{
  "success": false,
  "error": "Database query failed: connection timeout"
}
```

## Notes
- Body parameters take precedence over URL parameters when both are provided
- The search functionality performs case-insensitive partial matching across multiple fields
- Expansion of related records is optional and can significantly increase response size
- Maximum limit is 100 records per page to prevent performance issues
- Search queries automatically expand customer and order data for searching, but only return requested expansions in the final result 