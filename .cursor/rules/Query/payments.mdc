---
description: 
globs: 
alwaysApply: false
---
# Payment Query API

## Endpoint
**POST** `/server/payment/query`

## Description
Query payments with advanced filtering, pagination, expansion of related records, and full-text search capabilities. This endpoint provides a unified interface for retrieving payment data with flexible parameter handling.

## Request Parameters

### URL Query Parameters (Optional)
All parameters can be provided via URL query string:
- `page` (number): Page number for pagination (default: 1)
- `limit` (number): Number of records per page (default: 50)
- `orderBy` (string): Column to sort by (default: 'created_at')
- `ascending` (boolean): Sort order - true for ascending, false for descending (default: false)
- `search` (string): Search term for multi-field search
- `expand` (string): Comma-separated list of relations to expand

### Request Body Parameters (Optional)
All parameters can also be provided in the request body (takes precedence over query parameters):

```json
{
  "page": 1,
  "limit": 50,
  "orderBy": "created_at",
  "ascending": false,
  "search": "search term",
  "expand": ["customer", "order"],
  "filters": {
    "status": "PAID",
    "type": "GATEWAY",
    "customer": "customer-uuid",
    "order": "order-uuid"
  }
}
```

### Available Expansions
- `customer`: Include customer details
- `order`: Include order details  
- `all`: Include all available expansions

### Available Filters
- `status`: Payment status (PAID, UNPAID, REFUNDED)
- `type`: Payment type (GATEWAY, COD, BANK_TRANSFER, MANUAL)
- `customer`: Customer ID
- `order`: Order ID
- `currency`: Currency code
- `provider_name`: Payment provider name

## Example Requests

### Basic Query
```bash
curl -X POST http://localhost:3000/server/payment/query \
  -H "Content-Type: application/json" \
  -d '{
    "page": 1,
    "limit": 20
  }'
```

### Query with Filters
```bash
curl -X POST http://localhost:3000/server/payment/query \
  -H "Content-Type: application/json" \
  -d '{
    "page": 1,
    "limit": 50,
    "filters": {
      "status": "PAID",
      "type": "GATEWAY"
    },
    "orderBy": "paid_at",
    "ascending": false
  }'
```

### Query with Expansions
```bash
curl -X POST http://localhost:3000/server/payment/query \
  -H "Content-Type: application/json" \
  -d '{
    "page": 1,
    "limit": 25,
    "expand": ["customer", "order"],
    "filters": {
      "customer": "123e4567-e89b-12d3-a456-426614174000"
    }
  }'
```

### Search Query
```bash
curl -X POST http://localhost:3000/server/payment/query \
  -H "Content-Type: application/json" \
  -d '{
    "search": "stripe",
    "expand": ["customer"],
    "page": 1,
    "limit": 30
  }'
```

### Mixed Parameters (URL + Body)
```bash
curl -X POST "http://localhost:3000/server/payment/query?page=2&limit=25" \
  -H "Content-Type: application/json" \
  -d '{
    "search": "john@example.com",
    "expand": ["customer", "order"]
  }'
```

## Response Format

### Success Response (200 OK)
```json
{
  "success": true,
  "data": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "name": "PAY-001",
      "type": "GATEWAY",
      "amount": "99.99",
      "currency": "USD",
      "status": "PAID",
      "paid_at": "2024-01-15T10:30:00Z",
      "refunded_at": null,
      "external_name": "pi_1234567890",
      "provider_name": "stripe",
      "provider_status_title": "succeeded",
      "provider_status_code": 200,
      "customer": "customer-uuid",
      "order": "order-uuid",
      "created_at": "2024-01-15T10:00:00Z",
      "updated_at": "2024-01-15T10:30:00Z",
      "customer": {
        "id": "customer-uuid",
        "full_name": "John Doe",
        "email": "john@example.com",
        "phone": "+1234567890"
      },
      "order": {
        "id": "order-uuid",
        "name": "ORD-001",
        "status": "COMPLETED",
        "total": "99.99"
      }
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 5,
    "totalRecords": 125,
    "recordsPerPage": 25,
    "hasNextPage": true,
    "hasPreviousPage": false,
    "recordsOnCurrentPage": 25
  },
  "searchTerm": "stripe",
  "filters": {
    "status": "PAID"
  },
  "orderBy": {
    "column": "created_at",
    "ascending": false
  },
  "expansions": ["customer", "order"]
}
```

### Error Response (400 Bad Request)
```json
{
  "success": false,
  "error": "Invalid filter value"
}
```

### Error Response (500 Internal Server Error)
```json
{
  "success": false,
  "error": "Failed to query payments: Database connection error"
}
```

## Search Functionality

The search feature performs case-insensitive partial matching across multiple fields:

### Payment Fields
- `name`: Payment name/reference
- `type`: Payment type
- `status`: Payment status
- `external_name`: External reference
- `provider_name`: Payment provider
- `provider_status_title`: Provider status
- `amount`: Payment amount
- `currency`: Currency code
- `id`: Payment ID

### Related Record Fields (when expanded)
- **Customer**: full_name, email, phone, id
- **Order**: name, status, id

## Notes

- Parameters in request body take precedence over URL query parameters
- Search functionality searches through ALL payment records for comprehensive results
- Expansion cleanup ensures only requested relations are returned in the final response
- All timestamps are in ISO 8601 format
- Pagination is 1-based (first page is page 1)
- Default sorting is by `created_at` in descending order (newest first) 