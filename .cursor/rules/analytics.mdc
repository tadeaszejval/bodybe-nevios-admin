# Analytics Components API Documentation

## Table of Contents

1. [Overview](#overview)
2. [Authentication & General Usage](#authentication--general-usage)
3. [Component Endpoints](#component-endpoints)
   - [Single Metric Component](#single-metric-component)
   - [Timeseries Component](#timeseries-component)
   - [Breakdown Component](#breakdown-component)
4. [Common Parameters](#common-parameters)
5. [Response Format](#response-format)
6. [Value Types](#value-types)
7. [Available Metrics](#available-metrics)
8. [Error Handling](#error-handling)
9. [Examples](#examples)

---

## Overview

The Analytics Components API provides specialized endpoints designed for frontend components that display individual metrics with trends, comparisons, and timeseries data. These endpoints are optimized for dashboard widgets and analytics cards.

**Base URL:** `/server/analytics/components`

---

## Authentication & General Usage

All component endpoints follow the same patterns:
- **Method:** POST (for all endpoints)
- **Content-Type:** `application/json`
- **Required Parameters:** `market`, `date_from`, `date_to`
- **Optional Parameters:** `compare`, `compare_date_from`, `compare_date_to`

---

## Component Endpoints

### Single Metric Component

**Endpoint:** `POST /server/analytics/components/single-metric/:metric`

Get individual metric data with current value, comparison data, and simple timeseries for frontend components.

#### URL Parameters
- `metric` (string, required) - The metric key to retrieve data for

#### Request Body Parameters
```json
{
  "market": "string (required)",
  "date_from": "YYYY-MM-DD (required)",
  "date_to": "YYYY-MM-DD (required)",
  "compare": "string (optional)",
  "compare_date_from": "YYYY-MM-DD (optional)",
  "compare_date_to": "YYYY-MM-DD (optional)"
}
```

#### Response Format
```json
{
  "success": true,
  "data": {
    "metric": "revenue_total_gross",
    "value": 9266,
    "value_type": "currency",
    "compare_value": 8500,
    "trend_absolute": 766,
    "trend_percentage": 9.0,
    "timeseries": [
      {
        "date": "2025-06-25",
        "value": 0
      },
      {
        "date": "2025-06-26",
        "value": 0
      },
      {
        "date": "2025-06-27",
        "value": 9266
      }
    ]
  },
  "meta": {
    "metric": "revenue_total_gross",
    "date_range": {
      "from": "2025-06-25",
      "to": "2025-06-27"
    },
    "market": "vasky/czechia",
    "currency": "CZK",
    "value_type": "currency",
    "timeseries_points": 3,
    "comparison": {
      "type": "previous_period",
      "date_range": {
        "from": "2025-06-22",
        "to": "2025-06-24"
      }
    }
  }
}
```

### Timeseries Component

**Endpoint:** `POST /server/analytics/components/timeseries/:metric`

Get comprehensive timeseries data with total values, current period timeseries, comparison period timeseries, and trend analysis for frontend chart components.

**Note:** When querying a single day (date_from = date_to), automatically returns hourly breakdown with 24 data points (hours 00-23).

#### URL Parameters
- `metric` (string, required) - The metric key to retrieve timeseries data for

#### Request Body Parameters
```json
{
  "market": "string (required)",
  "date_from": "YYYY-MM-DD (required)",
  "date_to": "YYYY-MM-DD (required)",
  "compare": "string (optional)",
  "compare_date_from": "YYYY-MM-DD (optional)",
  "compare_date_to": "YYYY-MM-DD (optional)"
}
```

#### Response Format (Multi-Day)
```json
{
  "success": true,
  "data": {
    "metric": "revenue_total_gross",
    "total_value": 9266,
    "compare_total_value": 8500,
    "trend_absolute": 766,
    "trend_percentage": 9.0,
    "value_type": "currency",
    "timeseries": [
      {
        "date": "2025-06-25",
        "value": 0,
        "formatted_date": "Jun 25",
        "day_of_week": "Wed"
      },
      {
        "date": "2025-06-26",
        "value": 0,
        "formatted_date": "Jun 26",
        "day_of_week": "Thu"
      },
      {
        "date": "2025-06-27",
        "value": 9266,
        "formatted_date": "Jun 27",
        "day_of_week": "Fri"
      }
    ],
    "compare_timeseries": [
      {
        "date": "2025-06-22",
        "value": 0,
        "formatted_date": "Jun 22",
        "day_of_week": "Sun"
      },
      {
        "date": "2025-06-23",
        "value": 4500,
        "formatted_date": "Jun 23",
        "day_of_week": "Mon"
      },
      {
        "date": "2025-06-24",
        "value": 4000,
        "formatted_date": "Jun 24",
        "day_of_week": "Tue"
      }
    ]
  },
  "meta": {
    "metric": "revenue_total_gross",
    "date_range": {
      "from": "2025-06-25",
      "to": "2025-06-27"
    },
    "market": "vasky/czechia",
    "currency": "CZK",
    "value_type": "currency",
    "timeseries_points": 3,
    "compare_timeseries_points": 3,
    "is_single_day": false,
    "interval": "day",
    "comparison": {
      "type": "previous_period",
      "date_range": {
        "from": "2025-06-22",
        "to": "2025-06-24"
      }
    }
  }
}
```

#### Response Format (Single Day - Hourly)
```json
{
  "success": true,
  "data": {
    "metric": "revenue_total_gross",
    "total_value": 208476,
    "compare_total_value": null,
    "trend_absolute": null,
    "trend_percentage": null,
    "value_type": "currency",
    "timeseries": [
      {
        "date": "2026-01-17",
        "hour": "00",
        "value": 0,
        "formatted_hour": "12 AM"
      },
      {
        "date": "2026-01-17",
        "hour": "01",
        "value": 0,
        "formatted_hour": "1 AM"
      },
      {
        "date": "2026-01-17",
        "hour": "08",
        "value": 15230,
        "formatted_hour": "8 AM"
      },
      {
        "date": "2026-01-17",
        "hour": "09",
        "value": 28450,
        "formatted_hour": "9 AM"
      },
      {
        "date": "2026-01-17",
        "hour": "14",
        "value": 45600,
        "formatted_hour": "2 PM"
      },
      {
        "date": "2026-01-17",
        "hour": "23",
        "value": 0,
        "formatted_hour": "11 PM"
      }
    ],
    "compare_timeseries": null
  },
  "meta": {
    "metric": "revenue_total_gross",
    "date_range": {
      "from": "2026-01-17",
      "to": "2026-01-17"
    },
    "market": "bodybe/czechia",
    "currency": "CZK",
    "value_type": "currency",
    "timeseries_points": 24,
    "compare_timeseries_points": 0,
    "is_single_day": true,
    "interval": "hour"
  }
}
```

#### Timeseries Data Points

**Multi-Day Data Points:**
- **date** (string): ISO date string (YYYY-MM-DD)
- **value** (number): Metric value for that date
- **formatted_date** (string): Human-readable date format (e.g., "Jun 25")
- **day_of_week** (string): Short day name (e.g., "Wed")

**Single-Day Hourly Data Points:**
- **date** (string): ISO date string (YYYY-MM-DD)
- **hour** (string): Hour in HH format (00-23)
- **value** (number): Metric value for that hour
- **formatted_hour** (string): Human-readable hour format (e.g., "2 PM", "11 AM")

### Breakdown Component

**Endpoint:** `POST /server/analytics/components/breakdown/:breakdown_type`

Get comprehensive breakdown data with current period values, comparison data, and trend analysis for frontend components like lists, donuts, horizontal charts, and other breakdown visualizations.

#### URL Parameters
- `breakdown_type` (string, required) - The breakdown dimension to analyze

**Available Breakdown Types:**

**Order-Based Breakdowns** (returns revenue values):
- `payment_status` - Payment Status (paid, pending, failed, etc.)
- `fulfillment_status` - Fulfillment Status (fulfilled, unfulfilled, etc.)
- `payment_methods` - Payment Methods (card, bank_transfer, etc.)
- `shipping_methods` - Shipping Methods (standard, express, etc.)

**Session-Based Breakdowns** (returns session counts):
- `traffic_sources` - Traffic Sources (google, facebook, direct, etc.)
- `countries` - Countries (visitor countries)
- `devices` - Devices (desktop, mobile, tablet)
- `browsers` - Browsers (chrome, firefox, safari, etc.)

#### Request Body Parameters
```json
{
  "market": "string (required)",
  "date_from": "YYYY-MM-DD (required)",
  "date_to": "YYYY-MM-DD (required)",
  "compare": "string (optional)",
  "compare_date_from": "YYYY-MM-DD (optional)",
  "compare_date_to": "YYYY-MM-DD (optional)"
}
```

#### Response Format
```json
{
  "success": true,
  "data": {
    "breakdown_type": "payment_status",
    "total_value": 55596,
    "total_compare_value": 12500,
    "breakdown": [
      {
        "key": "paid",
        "label": "Paid",
        "value": 55596,
        "count": 2,
        "compare_value": 12500,
        "trend_absolute": 43096,
        "trend_percentage": 344.8
      },
      {
        "key": "pending",
        "label": "Pending",
        "value": 0,
        "count": 0,
        "compare_value": 0,
        "trend_absolute": 0,
        "trend_percentage": 0
      }
    ],
    "breakdown_count": 2
  },
  "error": null,
  "timestamp": "2025-06-27T23:15:30.123Z",
  "meta": {
    "breakdown_type": "payment_status",
    "date_range": {
      "from": "2025-06-25",
      "to": "2025-06-27"
    },
    "market": "vasky/czechia",
    "currency": "CZK",
    "breakdown_count": 2,
    "breakdown_category": "order",
    "comparison": {
      "type": "custom",
      "date_range": {
        "from": "2025-06-01",
        "to": "2025-06-03"
      }
    }
  }
}
```

#### Available Breakdown Types Endpoint

**Endpoint:** `GET /server/analytics/components/breakdown`

Get metadata about all available breakdown types and their configurations.

**Response Format:**
```json
{
  "success": true,
  "data": {
    "order_based": {
      "payment_status": {
        "label": "Payment Status",
        "description": "Breakdown by payment status (paid, pending, failed, etc.)",
        "value_type": "currency",
        "data_source": "orders"
      }
    },
    "session_based": {
      "traffic_sources": {
        "label": "Traffic Sources", 
        "description": "Breakdown by UTM source (google, facebook, direct, etc.)",
        "value_type": "number",
        "data_source": "sessions"
      }
    }
  },
  "meta": {
    "total_categories": 2,
    "total_breakdown_types": 8,
    "comparison_types": ["previous_period", "previous_year", "custom"],
    "breakdown_features": [
      "revenue_breakdown",
      "session_count_breakdown", 
      "trend_analysis",
      "comparison_breakdown",
      "sorting_by_value",
      "count_tracking"
    ]
  }
}
```

#### Breakdown Data Points
Each breakdown item includes:
- **key** (string): The breakdown identifier (e.g., "paid", "google")
- **label** (string): Human-readable label (e.g., "Paid", "Google")
- **value** (number): Current period value (revenue for orders, count for sessions)
- **count** (number): Number of items in this breakdown category
- **compare_value** (number|null): Comparison period value (if comparison requested)
- **trend_absolute** (number|null): Absolute change from comparison period
- **trend_percentage** (number|null): Percentage change from comparison period

---

## Common Parameters

### Required Parameters
- **market** (string): Market identifier (e.g., "vasky/czechia")
- **date_from** (string): Start date in YYYY-MM-DD format
- **date_to** (string): End date in YYYY-MM-DD format

### Optional Parameters
- **compare** (string): Comparison type
  - `"previous_period"` - Compare with previous period of same length
  - `"previous_year"` - Compare with same period last year
  - `"custom"` - Compare with custom date range (requires `compare_date_from` and `compare_date_to`)
  - `null` or omitted - No comparison
- **compare_date_from** (string): Custom comparison start date (required when `compare` is "custom")
- **compare_date_to** (string): Custom comparison end date (required when `compare` is "custom")

---

## Response Format

All component endpoints return a consistent response structure:

```json
{
  "success": boolean,
  "data": {
    // Component-specific data
  },
  "error": "string (only when success is false)",
  "meta": {
    // Metadata about the response
  }
}
```

### Single Metric Response Data
- **metric** (string): The metric key that was requested
- **value** (number): Current period value
- **value_type** (string): Type of value ("currency", "percentage", "duration", "number")
- **compare_value** (number|null): Comparison period value (if comparison requested)
- **trend_absolute** (number|null): Absolute change from comparison period
- **trend_percentage** (number|null): Percentage change from comparison period
- **timeseries** (array): Array of daily data points with date and value

### Timeseries Response Data
- **metric** (string): The metric key that was requested
- **total_value** (number): Total value for current period
- **compare_total_value** (number|null): Total value for comparison period (if comparison requested)
- **trend_absolute** (number|null): Absolute change from comparison period total
- **trend_percentage** (number|null): Percentage change from comparison period total
- **value_type** (string): Type of value ("currency", "percentage", "duration", "number")
- **timeseries** (array): Array of daily data points for current period with enhanced data
- **compare_timeseries** (array|null): Array of daily data points for comparison period (if comparison requested)

### Breakdown Response Data
- **breakdown_type** (string): The breakdown type that was requested
- **total_value** (number): Total value across all breakdown categories
- **total_compare_value** (number|null): Total comparison value across all categories (if comparison requested)
- **breakdown** (array): Array of breakdown items sorted by value (descending)
- **breakdown_count** (number): Number of breakdown categories found

---

## Value Types

Components return different value types based on the metric:

### Currency (`"currency"`)
- All revenue metrics
- `orders_avg_value`
- Values represent monetary amounts in the market's currency

### Percentage (`"percentage"`)
- `sessions_bounce_rate`
- `orders_conversion_rate`
- Values represent percentages (e.g., 25.5 for 25.5%)

### Duration (`"duration"`)
- `sessions_avg_duration`
- Values represent seconds

### Number (`"number"`)
- All count-based metrics (sessions, orders, page views)
- Values represent counts

---

## Available Metrics

### Revenue Metrics (Currency)
- `revenue_total_gross` - Total Revenue (Gross)
- `revenue_total_net` - Total Revenue (Net)
- `revenue_total_vat` - Total VAT
- `revenue_subtotal_gross` - Subtotal (Gross)
- `revenue_subtotal_net` - Subtotal (Net)
- `revenue_subtotal_vat` - Subtotal VAT
- `revenue_shipping_gross` - Shipping Revenue (Gross)
- `revenue_shipping_net` - Shipping Revenue (Net)
- `revenue_shipping_vat` - Shipping VAT
- `revenue_payment_gross` - Payment Fees (Gross)
- `revenue_payment_net` - Payment Fees (Net)
- `revenue_payment_vat` - Payment Fees VAT
- `revenue_tip_gross` - Tips (Gross)
- `revenue_tip_net` - Tips (Net)
- `revenue_tip_vat` - Tips VAT

### Session Metrics
- `sessions_total` - Total Sessions (Number)
- `sessions_new` - New Sessions (Number)
- `sessions_returning` - Returning Sessions (Number)
- `sessions_bounce_rate` - Bounce Rate (Percentage)
- `sessions_avg_duration` - Average Session Duration (Duration)
- `sessions_total_page_views` - Total Page Views (Number)
- `sessions_avg_page_views` - Average Pages per Session (Number)

### Order Metrics
- `orders_total` - Total Orders (Number)
- `orders_avg_value` - Average Order Value (Currency)
- `orders_conversion_rate` - Conversion Rate (Percentage)

---

## Error Handling

### Common Error Responses

#### 400 Bad Request - Missing Parameters
```json
{
  "success": false,
  "error": "Missing required parameters: market, date_from, date_to"
}
```

#### 400 Bad Request - Invalid Metric
```json
{
  "success": false,
  "error": "Invalid metric: invalid_metric. Valid metrics: revenue_total_gross, revenue_total_net, ..."
}
```

#### 500 Internal Server Error
```json
{
  "success": false,
  "error": "Internal server error",
  "message": "Detailed error message"
}
```

---

## Examples

### Basic Single Metric Request
```bash
curl -X POST "http://localhost:3000/server/analytics/components/single-metric/revenue_total_gross" \
  -H "Content-Type: application/json" \
  -d '{
    "market": "vasky/czechia",
    "date_from": "2025-06-25",
    "date_to": "2025-06-27"
  }'
```

### Single Metric with Comparison
```bash
curl -X POST "http://localhost:3000/server/analytics/components/single-metric/sessions_total" \
  -H "Content-Type: application/json" \
  -d '{
    "market": "vasky/czechia",
    "date_from": "2025-06-25",
    "date_to": "2025-06-27",
    "compare": "previous_period"
  }'
```

### Single Metric with Custom Comparison
```bash
curl -X POST "http://localhost:3000/server/analytics/components/single-metric/orders_conversion_rate" \
  -H "Content-Type: application/json" \
  -d '{
    "market": "vasky/czechia",
    "date_from": "2025-06-25",
    "date_to": "2025-06-27",
    "compare": "custom",
    "compare_date_from": "2025-06-01",
    "compare_date_to": "2025-06-03"
  }'
```

### Basic Timeseries Request
```bash
curl -X POST "http://localhost:3000/server/analytics/components/timeseries/revenue_total_gross" \
  -H "Content-Type: application/json" \
  -d '{
    "market": "vasky/czechia",
    "date_from": "2025-06-25",
    "date_to": "2025-06-27"
  }'
```

### Timeseries with Comparison
```bash
curl -X POST "http://localhost:3000/server/analytics/components/timeseries/sessions_total" \
  -H "Content-Type: application/json" \
  -d '{
    "market": "vasky/czechia",
    "date_from": "2025-06-25",
    "date_to": "2025-06-27",
    "compare": "previous_period"
  }'
```

### Basic Breakdown Request
```bash
curl -X POST "http://localhost:3000/server/analytics/components/breakdown/payment_status" \
  -H "Content-Type: application/json" \
  -d '{
    "market": "vasky/czechia",
    "date_from": "2025-06-25",
    "date_to": "2025-06-27"
  }'
```

### Breakdown with Comparison
```bash
curl -X POST "http://localhost:3000/server/analytics/components/breakdown/traffic_sources" \
  -H "Content-Type: application/json" \
  -d '{
    "market": "vasky/czechia",
    "date_from": "2025-06-25",
    "date_to": "2025-06-27",
    "compare": "previous_period"
  }'
```

### Get Available Breakdown Types
```bash
curl -X GET "http://localhost:3000/server/analytics/components/breakdown" \
  -H "Content-Type: application/json"
```

### Example Single Metric Response
```json
{
  "success": true,
  "data": {
    "metric": "revenue_total_gross",
    "value": 9266,
    "value_type": "currency",
    "compare_value": null,
    "trend_absolute": null,
    "trend_percentage": null,
    "timeseries": [
      {
        "date": "2025-06-25",
        "value": 0
      },
      {
        "date": "2025-06-26",
        "value": 0
      },
      {
        "date": "2025-06-27",
        "value": 9266
      }
    ]
  },
  "meta": {
    "metric": "revenue_total_gross",
    "date_range": {
      "from": "2025-06-25",
      "to": "2025-06-27"
    },
    "market": "vasky/czechia",
    "currency": "CZK",
    "value_type": "currency",
    "timeseries_points": 3
  }
}
```

### Example Timeseries Response
```json
{
  "success": true,
  "data": {
    "metric": "revenue_total_gross",
    "total_value": 9266,
    "compare_total_value": null,
    "trend_absolute": null,
    "trend_percentage": null,
    "value_type": "currency",
    "timeseries": [
      {
        "date": "2025-06-25",
        "value": 0,
        "formatted_date": "Jun 25",
        "day_of_week": "Wed"
      },
      {
        "date": "2025-06-26",
        "value": 0,
        "formatted_date": "Jun 26",
        "day_of_week": "Thu"
      },
      {
        "date": "2025-06-27",
        "value": 9266,
        "formatted_date": "Jun 27",
        "day_of_week": "Fri"
      }
    ],
    "compare_timeseries": null
  },
  "meta": {
    "metric": "revenue_total_gross",
    "date_range": {
      "from": "2025-06-25",
      "to": "2025-06-27"
    },
    "market": "vasky/czechia",
    "currency": "CZK",
    "value_type": "currency",
    "timeseries_points": 3,
    "compare_timeseries_points": 0
  }
}
```

---

**Note:** This documentation will be expanded as new component endpoints are added to the system.