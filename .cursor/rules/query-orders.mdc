---
description: 
globs: 
alwaysApply: false
---
# Order Query API

## Overview
The Order Query API provides flexible endpoints for retrieving and searching order records with comprehensive filtering, pagination, and expansion capabilities.

## Parameters Reference

### Core Parameters
| Parameter | Type | Location | Default | Description |
|-----------|------|----------|---------|-------------|
| `page` | integer | URL/Body | 1 | Page number (1-based) |
| `limit` | integer | URL/Body | 50 | Records per page (max: 100) |
| `orderBy` | string | URL/Body | 'created_at' | Column to sort by |
| `ascending` | boolean | URL/Body | false | Sort order (true = ascending, false = descending) |
| `select` | string | URL/Body | '*' | Columns to select |
| `expand` | string/array | URL/Body | [] | Related records to expand |

### Expansion Options
| Expansion | Description | Returns |
|-----------|-------------|---------|
| `customer` | Full customer details | Complete customer object with email, name, phone, etc. |
| `shipping_address` | Complete shipping address | Full address object with street, city, country, etc. |
| `billing_address` | Complete billing address | Full address object with street, city, country, etc. |
| `addresses` | Both shipping and billing addresses | Both address objects expanded |
| `items` | All order items | Array of order items with product details |

### Filter Parameters (Body Only)
| Parameter | Type | Description | Example |
|-----------|------|-------------|---------|
| `filters.payment_status` | string | Filter by payment status | "PAID", "UNPAID", "PENDING" |
| `filters.fulfillment_status` | string | Filter by fulfillment status | "FULFILLED", "UNFULFILLED", "PARTIAL" |
| `filters.local_currency` | string | Filter by local currency | "USD", "EUR", "CZK" |
| `filters.market_currency` | string | Filter by market currency | "USD", "EUR", "CZK" |
| `filters.home_currency` | string | Filter by home currency | "USD", "EUR", "CZK" |
| `filters.customer` | string | Filter by customer ID | "95e6d65c-5eff-4b69-932a-e373d9f153c1" |
| `filters.name` | string | Filter by order name | "OR0015/2025" |

### Search Parameters
| Parameter | Type | Location | Required | Description |
|-----------|------|----------|----------|-------------|
| `search` | string | Body | Yes (for search) | Search term to look for across multiple fields |

## Search Fields
The search functionality looks across the following fields:

### Order Table Fields
- `name` - Order name/number
- `payment_status` - Payment status
- `fulfillment_status` - Fulfillment status  
- `local_currency` - Local currency code
- `market_currency` - Market currency code
- `home_currency` - Home currency code

### Customer Fields (via expansion)
- `full_name` - Customer's full name
- `email` - Customer's email address
- `phone` - Customer's phone number

### Order Item Fields (via expansion)
- `product_title` - Product title
- `sku` - Product SKU

## Endpoints

### 1. Query Orders
**POST** `/api/server/order/query`

Retrieve orders with optional filtering, pagination, and expansion.

#### Example Requests

**Basic Query (URL Parameters)**
```bash
curl -X POST "http://localhost:3000/api/server/order/query?page=1&limit=10&expand=customer"
```

**Advanced Query (Request Body)**
```bash
curl -X POST http://localhost:3000/api/server/order/query \
  -H "Content-Type: application/json" \
  -d '{
    "page": 1,
    "limit": 10,
    "orderBy": "created_at",
    "ascending": false,
    "expand": ["customer"],
    "filters": {
      "payment_status": "PAID",
      "fulfillment_status": "FULFILLED",
      "local_currency": "CZK"
    }
  }'
```

**Search Query**
```bash
curl -X POST http://localhost:3000/api/server/order/query \
  -H "Content-Type: application/json" \
  -d '{
    "page": 1,
    "limit": 10,
    "expand": ["customer"],
    "search": "Tadeáš Zejval",
    "filters": {
      "payment_status": "UNPAID"
    }
  }'
```

**Expansion Examples**
```bash
# Expand customer only
curl -X POST "http://localhost:3000/api/server/order/query" \
  -H "Content-Type: application/json" \
  -d '{"expand": ["customer"]}'

# Expand multiple relations (Body)
curl -X POST http://localhost:3000/api/server/order/query \
  -H "Content-Type: application/json" \
  -d '{
    "expand": ["customer", "addresses", "items"]
  }'
```

## Response Structure

### Success Response with Expansion
```json
{
  "success": true,
  "data": [
    {
      "id": "a936b14f-0246-4d18-9684-793c41db0c60",
      "name": "OR0015/2025",
      "local_currency": "CZK",
      "market_currency": "vasky/czechia/CZK",
      "customer": {
        "id": "95e6d65c-5eff-4b69-932a-e373d9f153c1",
        "tags": null,
        "email": "zejval.tadeas@icloud.com",
        "phone": "+420 736 165 565",
        "gender": "MALE",
        "country": null,
        "benefits": null,
        "full_name": "Tadeáš Zejval",
        "last_name": "Zejval",
        "created_at": "2025-05-23T09:25:36.681424+00:00",
        "first_name": "Tadeáš",
        "subscribed": true,
        "account_enabled": false,
        "default_billing": "2df48324-358b-4d6e-a24e-9f1a0f2c2a70",
        "default_shipping": "3165a31c-4f21-4d24-9802-088a42e95bd4"
      },
      "session": null,
      "shipping_set": "af579a7d-2a1c-43ce-988d-93b5d1928fb5",
      "payment_set": "eef4fce0-043e-496c-9f79-e63c46977bd1",
      "shipping_method": {
        "id": "0898421f-5dce-4cd2-a1b8-af8100fa94d1",
        "name": "Zásilkovna",
        "type": "POINT",
        "price": 69,
        "handle": "zasilkovna_cz",
        "widget": "zasilkovna",
        "currency": "CZK",
        "description": "Doručení na výdejní místo nebo do Z-Boxu"
      },
      "payment_method": {
        "id": "6e353ef0-2421-475a-ac72-b090dd3c5495",
        "name": "Platební brána",
        "type": "GATEWAY",
        "price": 0,
        "handle": "csob",
        "currency": "CZK",
        "description": "Po dokončení objednávky budete přesměrováni do platební brány.",
        "require_payment": true
      },
      "shipping_address": "3165a31c-4f21-4d24-9802-088a42e95bd4",
      "billing_address": "2df48324-358b-4d6e-a24e-9f1a0f2c2a70",
      "payment_status": "UNPAID",
      "fulfillment_status": "UNFULFILLED",
      "home_currency": "CZK",
      "fx_rate": 1,
      "created_at": "2025-05-26T12:38:19.14569+00:00"
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 10,
    "totalRecords": 10,
    "recordsPerPage": 1,
    "hasNextPage": true,
    "hasPreviousPage": false,
    "recordsOnCurrentPage": 1
  },
  "searchTerm": "Tadeáš Zejval",
  "filters": {},
  "orderBy": {
    "column": "created_at",
    "ascending": false
  },
  "expansions": ["customer"]
}
```

### Response Without Expansions
```json
{
  "success": true,
  "data": [
    {
      "id": "a936b14f-0246-4d18-9684-793c41db0c60",
      "name": "OR0015/2025",
      "local_currency": "CZK",
      "market_currency": "vasky/czechia/CZK",
      "customer": "95e6d65c-5eff-4b69-932a-e373d9f153c1",
      "shipping_address": "3165a31c-4f21-4d24-9802-088a42e95bd4",
      "billing_address": "2df48324-358b-4d6e-a24e-9f2c2a70",
      "payment_status": "UNPAID",
      "fulfillment_status": "UNFULFILLED",
      "home_currency": "CZK",
      "fx_rate": 1,
      "created_at": "2025-05-26T12:38:19.14569+00:00"
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 5,
    "totalRecords": 47,
    "recordsPerPage": 10,
    "hasNextPage": true,
    "hasPreviousPage": false,
    "recordsOnCurrentPage": 10
  },
  "expansions": []
}
```

## Error Responses

### 400 Bad Request
```json
{
  "success": false,
  "error": "Limit must be between 1 and 100"
}
```

### 500 Internal Server Error
```json
{
  "success": false,
  "error": "Failed to query orders: Database query failed"
}
```

## Search Behavior

### Search Implementation
The search functionality uses a hybrid approach:
1. **Database Search**: Searches order table fields directly
2. **Expansion**: Automatically expands customer and items data for search
3. **Client-Side Filtering**: Filters expanded results for customer and product matches
4. **Cleanup**: Removes unwanted expansions from final results

### Search Performance Notes
- Search fetches up to 100 records (2x requested limit, max 100) to account for filtering
- Results are filtered client-side after expansion
- Pagination is applied to filtered results
- For large datasets, consider using specific filters instead of broad search terms

### Search Examples

| Search Term | Will Find Orders With |
|-------------|----------------------|
| `"Tadeáš"` | Customer first name "Tadeáš", full name containing "Tadeáš" |
| `"zejval.tadeas@icloud.com"` | Customer email exactly matching |
| `"OR0015"` | Order names containing "OR0015" |
| `"UNPAID"` | Orders with payment status "UNPAID" |
| `"Botas"` | Products with "Botas" in the title |
| `"S-5064"` | Products with SKU containing "S-5064" |
| `"+420"` | Customer phone numbers containing "+420" |

## Implementation Notes

- **Parameter Precedence**: Request body parameters override URL parameters
- **Expansion Efficiency**: Only requested relations are included in final response
- **Flexible Format**: Expand parameter accepts both string ("customer,addresses") and array (["customer", "addresses"]) formats
- **Search Scope**: Search automatically includes customer and order item data but only returns requested expansions
- **Performance**: Search operations may be slower due to client-side filtering
- **Limits**: Maximum 100 records per request, search fetches 2x requested limit for filtering

## Parameter Precedence

When the same parameter is provided in both URL and request body:

| Parameter | URL Value | Body Value | Result |
|-----------|-----------|------------|---------|
| `page` | `1` | `2` | `2` (body wins) |
| `limit` | `25` | `50` | `50` (body wins) |
| `expand` | `"customer"` | `["customer", "items"]` | `["customer", "items"]` (body wins) |

## Usage Patterns

### Simple Query
```bash
curl -X POST "http://localhost:3000/api/server/order/query?page=1&limit=10"
```

### Query with Expansion
```bash
curl -X POST "http://localhost:3000/api/server/order/query" \
  -H "Content-Type: application/json" \
  -d '{"expand": ["customer"]}'
```

### Search with Expansion
```bash
curl -X POST "http://localhost:3000/api/server/order/query" \
  -H "Content-Type: application/json" \
  -d '{
    "search": "customer@email.com",
    "expand": ["customer"],
    "filters": {"payment_status": "UNPAID"}
  }'
```

### Complex Query
```bash
curl -X POST "http://localhost:3000/api/server/order/query" \
  -H "Content-Type: application/json" \
  -d '{
    "page": 1,
    "limit": 25,
    "orderBy": "created_at",
    "ascending": false,
    "expand": ["customer", "items"],
    "search": "premium",
    "filters": {
      "payment_status": "PAID",
      "local_currency": "CZK"
    }
  }'
```

## Notes
- Maximum limit is 100 records per page
- Default pagination is 50 records per page
- Results are ordered by `created_at` in descending order by default
- Empty filters are automatically ignored
- These endpoints do not trigger any events (query operations are read-only)
- All timestamps are returned in ISO 8601 format with timezone information
- Search functionality automatically includes related customer and product data for filtering
- Search terms are trimmed and validated before processing
- Request body parameters always take precedence over URL parameters
- Shipping and payment methods are returned as complete objects with all details
- Address references are returned as UUIDs unless expanded
- Currency information includes local, market, and home currency with exchange rates